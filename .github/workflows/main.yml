name: CI

on: [push]

jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        #os: [ubuntu-16.04, windows-2016]
        #os: [windows-2016, macOS-latest]
        os: [macOS-latest]
        #os: [ubuntu-16.04]

    steps:
    - uses: actions/checkout@v1
      with:
        fetch-depth: 10

    #- name: Debug session
    #  uses: uavos/action-tmate@v1

    - name: Prepare (Linux)
      if: matrix.os == 'ubuntu-16.04'
      run: |
        sudo apt-get install libtool-bin libtommath0 libtommath-dev libicu-dev zlib1g-dev

    - name: Build (Linux)
      if: matrix.os == 'ubuntu-16.04'
      run: |
        CC=clang CXX=clang++ ./autogen.sh --enable-binreloc --with-builtin-tomcrypt --prefix=/opt/firebird
        make
        make dist
        tar xzvf gen/Firebird-[0-9]*.tar.gz
        (cd Firebird-[0-9]*; sudo ./install.sh -silent)

    - name: Prepare (MacOS)
      if: matrix.os == 'macOS-latest'
      run: |
        #curl https://ipinfo.io/ip
        #echo x0
        #brew install tmux tmate reattach-to-user-namespace
        #echo x0
        #echo "set-option -g default-command \"which reattach-to-user-namespace > /dev/null && reattach-to-user-namespace -l \$SHELL || \$SHELL\"" >> ~/.tmux.conf
        #echo x1
        #tmate -S /tmp/tmate.sock new-session -d
        #sleep 5
        #echo x2
        #tmate -S /tmp/tmate.sock wait tmate-ready
        #sleep 10
        #echo x3
        #sleep 10
        ##tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}'
        #echo x4
        #tmate -S /tmp/tmate.sock display -p '#{tmate_web}'
        #sleep 10
        #echo x5
        #tmate -S /tmp/tmate.sock show-messages
        #echo x6
        #sleep 121
        #echo x7
        brew install automake libtool
        ln -s /usr/local/bin/glibtoolize /usr/local/bin/libtoolize
        ln -s /usr/local/bin/glibtool /usr/local/bin/libtool
        #brew install icu4c
        #brew link icu4c --force
        #brew info icu4c
        #brew install libtommath
        #brew install libtomcrypt
        mkdir extern/icu-macos
        cd extern/icu-macos
        #wget http://download.icu-project.org/files/icu4c/54.1/icu4c-54_1-src.tgz
        #tar xzvf icu4c-54_1-src.tgz
        wget https://github.com/unicode-org/icu/releases/download/release-59-2/icu4c-59_2-src.tgz
        wget https://github.com/unicode-org/icu/commit/24aeb9a5a5874f4ce5db912e30670ac3ae236971.patch
        tar xzvf icu4c-59_2-src.tgz
        cd icu/source
        patch -p3 < ../../24aeb9a5a5874f4ce5db912e30670ac3ae236971.patch
        CONFIG_CPPFLAGS="-DUPLUG_TRACE=1" UCONFIG_CPPFLAGS="-DUPLUG_TRACE=1" ./runConfigureICU MacOSX --enable-debug
        make -j4
        sudo make install
        symbols /usr/local/lib/libicuuc.dylib

    - name: Build (MacOS)
      if: matrix.os == 'macOS-latest'
      run: |
        env
        #export PATH="/usr/local/opt/icu4c/bin:$PATH"
        #export PATH="/usr/local/opt/icu4c/sbin:$PATH"
        #export LDFLAGS="-L/usr/local/opt/icu4c/lib"
        #export CPPFLAGS="-I/usr/local/opt/icu4c/include -stdlib=libc++"
        #export CXX="g++ -I/usr/local/opt/icu4c/include -stdlib=libc++"
        export CPPFLAGS="-stdlib=libc++"
        export CXX="g++ -stdlib=libc++"
        #export DYLD_LIBRARY_PATH=/usr/local/lib:$DYLD_LIBRARY_PATH
        #export DYLD_FALLBACK_LIBRARY_PATH=/usr/local/lib:$DYLD_FALLBACK_LIBRARY_PATH
        ./autogen.sh --with-builtin-tommath
        make -j4
        #make dist

    - name: Prepare (Windows)
      if: matrix.os == 'windows-2016'
      shell: cmd
      run: |
        for /r %%i in (*.bat) do unix2dos "%%i"

    - name: Build (Windows)
      if: matrix.os == 'windows-2016'
      shell: cmd
      run: |
        call "C:\Program Files (x86)\Microsoft Visual Studio\2017\Enterprise\Common7\Tools\VsDevCmd.bat" -arch=amd64
        cd builds\win32
        run_all.bat JUSTBUILD

    - name: Upload (Linux)
      if: matrix.os == 'ubuntu-16.04'
      uses: actions/upload-artifact@master
      with:
        name: firebird.tar.gz
        path: gen/Firebird-[0-9]*.tar.gz

    - name: Upload (MacOS)
      if: matrix.os == 'macOS-latest'
      uses: actions/upload-artifact@master
      with:
        name: firebird.tar.gz
        path: gen/Release/firebird

    - name: Upload (Windows)
      if: matrix.os == 'windows-2016'
      uses: actions/upload-artifact@master
      with:
        name: firebird.zip
        path: output_x64
